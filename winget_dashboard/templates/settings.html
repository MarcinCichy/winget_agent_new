{% extends "base.html" %}

{% block title %}Ustawienia i Zarządzanie Agentem{% endblock %}

{% block header_main_left %}
    <a href="{{ url_for('views.index') }}" class="back-link">&larr; Powrót do strony głównej</a>
{% endblock %}

{% block sub_header %}
    <h1>Ustawienia i Zarządzanie Agentem</h1>
{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="notification-bar" style="background-color: {{ '#28a745' if category == 'success' else '#dc3545' }}; color: white; padding: 1rem; margin-bottom: 1rem; border-radius: 5px;">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="settings-grid">
        <div class="settings-panel">
            <h2>Generator Agenta</h2>
            <p>Wypełnij poniższy formularz, aby wygenerować niestandardowy plik <strong>agent.exe</strong> z "wypalonymi" ustawieniami.</p>

            <form id="generate-agent-form" action="{{ url_for('views.generate_exe') }}" method="POST" class="settings-form">
                <div class="form-group">
                    <label for="api_endpoint_1">Adres serwera (API Endpoint):</label>
                    <input type="text" id="api_endpoint_1" name="api_endpoint_1" value="http://TWOJ_ADRES_IP:5000" required>
                    <small>Podstawowy adres serwera (bez /api/report).</small>
                </div>
                <div class="form-group">
                    <label for="api_key">Klucz API (API Key):</label>
                    <input type="text" id="api_key" name="api_key" value="{{ server_api_key }}" required>
                    <small>Klucz API musi być identyczny jak ten w pliku .env na serwerze.</small>
                </div>
                <div class="form-group">
                    <label for="winget_path">Alternatywna ścieżka do winget.exe (opcjonalnie):</label>
                    <input type="text" id="winget_path" name="winget_path" value="">
                    <small>Podaj, jeśli winget jest w niestandardowej lokalizacji.</small>
                </div>
                <div class="form-group">
                    <label for="loop_interval">Interwał sprawdzania zadań (w sekundach):</label>
                    <input type="number" id="loop_interval" name="loop_interval" value="30" required>
                    <small>Co ile sekund agent ma pytać serwer o nowe zadania.</small>
                </div>
                 <div class="form-group">
                    <label for="report_interval">Interwał pełnego raportu (w sekundach):</label>
                    <input type="number" id="report_interval" name="report_interval" value="3600" required>
                    <small>Co ile sekund agent ma wysyłać pełny raport o stanie.</small>
                </div>
                <button id="generate-agent-btn" type="submit" class="action-btn btn-report">Generuj agent.exe</button>
            </form>
        </div>

        <div class="settings-panel">
            <h2>Zarządzanie Wersją i Aktualizacjami</h2>
            <p>Wgraj nową wersję agenta na serwer, a następnie zleć jej wdrożenie na wszystkich komputerach.</p>

            <div class="update-section">
                <h3>Obecna Wersja Agenta na Serwerze</h3>
                {% if agent_info %}
                    <p>
                        <strong>Plik:</strong> {{ agent_info.name }}<br>
                        <strong>Rozmiar:</strong> {{ agent_info.size_kb }} KB<br>
                        <strong>Data modyfikacji:</strong> {{ agent_info.modified_date }}
                    </p>
                {% else %}
                    <p class="status-fail">Na serwerze nie ma jeszcze pliku agent.exe. Wgraj go poniżej.</p>
                {% endif %}
            </div>

            <div class="update-section">
                <h3>Wgraj Nową Wersję Agenta</h3>
                <form action="{{ url_for('views.settings') }}" method="POST" enctype="multipart/form-data" class="settings-form">
                    <div class="form-group">
                        <label>Wybierz plik agent.exe:</label>
                        <div class="file-upload-container">
                            <label for="agent_file_input" class="action-btn btn-secondary">Wybierz agenta</label>
                            <input type="file" id="agent_file_input" name="agent_file" accept=".exe" required class="file-upload-input">
                            <span id="file-chosen-label" class="file-upload-label">Nie wybrano pliku.</span>
                        </div>
                    </div>
                    <button type="submit" class="action-btn btn-report">Wgraj plik</button>
                </form>
            </div>

            <div class="update-section">
                <h3>Zarządzanie Wdrożeniem</h3>
                <p>Użyj tego przycisku, aby zlecić wszystkim agentom pobranie i zainstalowanie najnowszej wersji wgranej powyżej.</p>
                <button id="deploy-all-btn" class="action-btn btn-secondary" {% if not agent_info %}disabled{% endif %}>
                    Wdróż aktualizację na wszystkich komputerach
                </button>
            </div>
        </div>
    </div>
{% endblock %}
{% extends "base.html" %}

{% block title %}Szczegóły - {{ computer.hostname }}{% endblock %}

{% block header_main_left %}
    <a href="{{ url_for('views.index') }}" class="back-link">&larr; Powrót do listy</a>
{% endblock %}

{% block header_main_right %}
    {% if updates|length > 0 %}
        <button class="action-btn btn-danger update-all-btn" data-computer-id="{{ computer.id }}">Akt. wszystko</button>
    {% endif %}
    <a href="{{ url_for('views.report_single', computer_id=computer.id) }}" class="action-btn btn-report">Generuj raport</a>
    <button class="action-btn refresh-btn" data-computer-id="{{ computer.id }}">Odśwież</button>
    <a href="{{ url_for('views.computer_history', hostname=computer.hostname) }}" class="action-btn btn-secondary">Pokaż historię</a>
{% endblock %}

{% block sub_header %}
<div class="header-sub-grid">
    <div class="sub-grid-left">
        <h1>{{ computer.hostname }}</h1>
        <p><strong>IP:</strong> {{ computer.ip_address }} | <strong>Ostatni raport:</strong> {{ computer.last_report | to_local_time }}</p>
    </div>
    <div class="sub-grid-right">
        <form id="blacklist-form" class="blacklist-editor">
            <div class="editor-header">
                <label for="blacklist-keywords">Czarna lista (oddzielona przecinkami):</label>
                <button type="submit" class="action-btn btn-report">Zapisz zmiany</button>
            </div>
            <textarea id="blacklist-keywords" name="blacklist_keywords" rows="3">{{ editable_blacklist }}</textarea>
        </form>
    </div>
</div>
{% endblock %}

{% block content %}
    {% if computer.reboot_required %}
    <div class="notification-bar" style="background-color: #ffc107; color: #212529;">
        <strong>UWAGA:</strong> Ten komputer wymaga ponownego uruchomienia, aby zakończyć instalację oczekujących aktualizacji.
    </div>
    {% endif %}

    <div id="notification-bar" style="display: none;"></div>

    <h2>Dostępne aktualizacje ({{ updates|length }})</h2>
    <table>
        <thead style="background-color: #28a745;">
            <tr>
                <th style="width: 15%;">Typ</th>
                <th>Nazwa / Tytuł</th>
                <th style="width: 20%;">Status</th>
                <th style="width: 15%;">Wersje</th>
                <th style="width: 15%;">Akcja</th>
            </tr>
        </thead>
        <tbody>
            {% for update in updates %}
            <tr>
                <td>{{ 'System Operacyjny' if update.update_type == 'OS' else 'Aplikacja' }}</td>
                <td>{{ update.name }}</td>
                <td>
                    {% set task_key = 'os_update' if update.update_type == 'OS' else update.app_id %}
                    {% if task_key in task_statuses %}
                        {% set task = task_statuses[task_key] %}
                        <span class="status-{{ 'pending' if 'niepowodzenie' not in task.status and 'błąd' not in task.status else 'fail' }}">
                            {{ task.status | replace('_', ' ') | capitalize }}
                        </span>
                        {% if 'niepowodzenie' in task.status or 'błąd' in task.status or 'zakończone' in task.status %}
                            <button class="action-btn-link details-btn" data-task-id="{{ task.id }}">(pokaż szczegóły)</button>
                        {% endif %}
                    {% else %}
                        <span>Dostępna</span>
                    {% endif %}
                </td>
                <td>{{ update.current_version or 'N/A' }} -> {{ update.available_version or 'N/A' }}</td>
                <td>
                    {# --- LOGIKA WYŚWIETLANIA PRZYCISKU --- #}
                    {% set task_key = 'os_update' if update.update_type == 'OS' else update.app_id %}
                    {% set task_is_active = false %}
                    {% if task_key in task_statuses %}
                        {% set active_statuses = ['oczekuje', 'w_trakcie_wykonywania', 'oczekuje_na_uzytkownika', 'w_trakcie_aktualizacji', 'zaplanowane_na_logowanie'] %}
                        {% if task_statuses[task_key].status in active_statuses %}
                            {% set task_is_active = true %}
                        {% endif %}
                    {% endif %}

                    {% if not task_is_active %}
                        <div class="action-group">
                            {% set pkg_id = 'os_update' if update.update_type == 'OS' else update.app_id %}
                            <button class="action-btn update-btn main-action" data-action="request_update" data-computer-id="{{ computer.id }}" data-package-id="{{ pkg_id }}">Poproś</button>
                            <button class="action-btn update-btn dropdown-toggle" aria-haspopup="true" aria-expanded="false">&#9662;</button>
                            <div class="dropdown-menu">
                                <a href="#" class="dropdown-item" data-action="request_update" data-computer-id="{{ computer.id }}" data-package-id="{{ pkg_id }}">Poproś o aktualizację</a>
                                <a href="#" class="dropdown-item" data-action="force_update" data-computer-id="{{ computer.id }}" data-package-id="{{ pkg_id }}">Wymuś aktualizację</a>
                            </div>
                        </div>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="5">Brak oczekujących aktualizacji.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Zainstalowane aplikacje ({{ apps|length }})</h2>
    <table>
        <thead style="background-color: #17a2b8;">
            <tr>
                <th>Nazwa</th>
                <th>ID Aplikacji</th>
                <th style="width: 15%;">Wersja</th>
                <th style="width: 20%;">Status</th>
                <th style="width: 15%;">Akcja</th>
            </tr>
        </thead>
        <tbody>
            {% for app in apps %}
            <tr>
                <td>{{ app.name }}</td>
                <td>{{ app.app_id }}</td>
                <td>{{ app.version }}</td>
                <td>
                    {% if app.app_id in task_statuses %}
                        {% set task = task_statuses[app.app_id] %}
                         {% if task.command.startswith('request_uninstall') or task.command.startswith('force_uninstall') %}
                            <span class="status-{{ 'pending' if 'niepowodzenie' not in task.status and 'błąd' not in task.status else 'fail' }}">
                                {{ task.status | replace('_', ' ') | capitalize }}
                            </span>
                            {% if 'niepowodzenie' in task.status or 'błąd' in task.status or 'zakończone' in task.status %}
                                <button class="action-btn-link details-btn" data-task-id="{{ task.id }}">(pokaż szczegóły)</button>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    {# --- LOGIKA WYŚWIETLANIA PRZYCISKU --- #}
                    {% set task_is_active = false %}
                    {% if app.app_id in task_statuses %}
                        {% set task = task_statuses[app.app_id] %}
                        {% if task.command.startswith('request_uninstall') or task.command.startswith('force_uninstall') %}
                            {% set active_statuses = ['oczekuje', 'w_trakcie_wykonywania', 'oczekuje_na_uzytkownika', 'w_trakcie_aktualizacji', 'zaplanowane_na_logowanie'] %}
                            {% if task.status in active_statuses %}
                                {% set task_is_active = true %}
                            {% endif %}
                        {% endif %}
                    {% endif %}

                    {% if not task_is_active %}
                        <div class="action-group">
                            <button class="action-btn uninstall-btn main-action" data-action="request_uninstall" data-computer-id="{{ computer.id }}" data-package-id="{{ app.app_id }}">Poproś</button>
                            <button class="action-btn uninstall-btn dropdown-toggle" aria-haspopup="true" aria-expanded="false">&#9662;</button>
                            <div class="dropdown-menu">
                                <a href="#" class="dropdown-item" data-action="request_uninstall" data-computer-id="{{ computer.id }}" data-package-id="{{ app.app_id }}">Poproś o deinstalację</a>
                                <a href="#" class="dropdown-item" data-action="force_uninstall" data-computer-id="{{ computer.id }}" data-package-id="{{ app.app_id }}">Wymuś deinstalację</a>
                            </div>
                        </div>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="5">Brak danych o aplikacjach.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="error-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Szczegóły błędu zadania</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="error-details-content"></pre>
            </div>
        </div>
    </div>
{% endblock %}